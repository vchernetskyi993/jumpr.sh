#!/usr/bin/env python

import os
import sys
from pathlib import Path
import yaml


def main():
    out_dir = _out_dir()
    script_name = Path(sys.argv[0]).name
    args = " ".join(sys.argv[1:])
    args_file = out_dir / f"{script_name}_args"
    out_dir.mkdir(parents=True, exist_ok=True)

    with args_file.open("a") as fh:
        _ = fh.write(f"{args}\n")

    mocks = _load_yaml_for_script(script_name)
    for call in mocks.keys():
        if call in args:
            print(mocks[call])

def _load_yaml_for_script(script_name: str) -> dict[str, str]:
    mocks_dir = _mocks_dir()
    if not mocks_dir:
        return {}

    candidates = [
        mocks_dir / f"{script_name}.yml",
        mocks_dir / f"{script_name}.yaml",
    ]

    for p in candidates:
        if p.is_file():
            with p.open("r", encoding="utf-8") as f:
                return yaml.safe_load(f) or {}
    return {}

def _out_dir() -> Path:
    stub_args = os.environ.get("OUT_DIR")
    if not stub_args:
        print("OUT_DIR must be set to a writable directory", file=sys.stderr)
        sys.exit(1)

    return Path(stub_args)


def _mocks_dir() -> Path | None:
    stub_args = os.environ.get("MOCKS_DIR")
    return Path(stub_args) if stub_args else None


if __name__ == "__main__":
    main()
